<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Inductobot.Views.DeviceConnectionPage"
             Title="Device Connection">
    
    <Grid RowDefinitions="Auto,*,Auto" Padding="20">
        
        <!-- Header Section -->
        <VerticalStackLayout Grid.Row="0" Spacing="10">
            <Label Text="Device Connection" 
                   FontSize="32" 
                   FontAttributes="Bold"
                   HorizontalOptions="Center"/>
            
            <Label Text="Discover and connect to industrial IoT devices"
                   FontSize="16"
                   TextColor="Gray"
                   HorizontalOptions="Center"/>
            
            <!-- Manual Connection Section -->
            <Frame BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2B2B2B}" 
                   BorderColor="Transparent"
                   Padding="15"
                   Margin="0,10">
                <Grid ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="10">
                    <Entry x:Name="IpAddressEntry" 
                           Placeholder="IP Address (e.g., 192.168.1.100)"
                           Grid.Column="0"/>
                    
                    <Entry x:Name="PortEntry" 
                           Placeholder="Port"
                           Text="80"
                           Keyboard="Numeric"
                           WidthRequest="80"
                           Grid.Column="1"/>
                    
                    <Button Text="Add"
                            Clicked="OnAddManualDeviceClicked"
                            Grid.Column="2"/>
                    
                    <Button Text="Connect"
                            Clicked="OnConnectManualClicked"
                            Grid.Column="3"/>
                </Grid>
            </Frame>
        </VerticalStackLayout>
        
        <!-- Device List Section -->
        <Grid Grid.Row="1" RowDefinitions="Auto,*" Margin="0,10">
            
            <!-- Scan Controls -->
            <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10" Margin="0,0,0,10">
                <Label Text="Discovered Devices" 
                       FontSize="20" 
                       FontAttributes="Bold"
                       VerticalOptions="Center"/>
                
                <ActivityIndicator x:Name="ScanIndicator" 
                                 IsRunning="False"
                                 WidthRequest="20"
                                 HeightRequest="20"
                                 Grid.Column="1"/>
                
                <Button x:Name="ScanButton"
                        Text="Scan Network"
                        Clicked="OnScanNetworkClicked"
                        Grid.Column="2"/>
            </Grid>
            
            <!-- Device List -->
            <CollectionView x:Name="DeviceList" 
                          Grid.Row="1"
                          SelectionMode="Single"
                          SelectionChanged="OnDeviceSelected">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Margin="0,5" 
                               Padding="15"
                               BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                               BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnDeviceTapped"/>
                            </Frame.GestureRecognizers>
                            
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                                <!-- Status Indicator -->
                                <Ellipse Grid.Column="0"
                                       WidthRequest="12"
                                       HeightRequest="12"
                                       VerticalOptions="Center">
                                    <Ellipse.Fill>
                                        <SolidColorBrush Color="{Binding IsOnline, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Green|Red}"/>
                                    </Ellipse.Fill>
                                </Ellipse>
                                
                                <!-- Device Info -->
                                <VerticalStackLayout Grid.Column="1" Spacing="5">
                                    <Label Text="{Binding Name}" 
                                         FontSize="16" 
                                         FontAttributes="Bold"/>
                                    
                                    <Label FontSize="14" TextColor="Gray">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding IpAddress}"/>
                                                <Span Text=":"/>
                                                <Span Text="{Binding Port}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                    
                                    <Label Text="{Binding FirmwareVersion, StringFormat='Firmware: {0}'}" 
                                         FontSize="12" 
                                         TextColor="Gray"
                                         IsVisible="{Binding FirmwareVersion, Converter={StaticResource NotNullConverter}}"/>
                                    
                                    <Label Text="{Binding SerialNumber, StringFormat='S/N: {0}'}" 
                                         FontSize="12" 
                                         TextColor="Gray"
                                         IsVisible="{Binding SerialNumber, Converter={StaticResource NotNullConverter}}"/>
                                </VerticalStackLayout>
                                
                                <!-- Action Buttons -->
                                <HorizontalStackLayout Grid.Column="2" Spacing="10" VerticalOptions="Center">
                                    <Button Text="Connect" 
                                          Clicked="OnConnectDeviceClicked"
                                          CommandParameter="{Binding .}"
                                          WidthRequest="80"
                                          HeightRequest="35"
                                          FontSize="12"/>
                                    
                                    <Button Text="Remove" 
                                          Clicked="OnRemoveDeviceClicked"
                                          CommandParameter="{Binding .}"
                                          BackgroundColor="Red"
                                          WidthRequest="80"
                                          HeightRequest="35"
                                          FontSize="12"/>
                                </HorizontalStackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                
                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="10">
                        <Image Source="dotnet_bot.png" 
                             WidthRequest="100" 
                             HeightRequest="100" 
                             Opacity="0.5"/>
                        <Label Text="No devices found" 
                             FontSize="18" 
                             TextColor="Gray"
                             HorizontalOptions="Center"/>
                        <Label Text="Click 'Scan Network' to discover devices or add one manually"
                             FontSize="14" 
                             TextColor="Gray"
                             HorizontalOptions="Center"
                             HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>
        
        <!-- Status Bar -->
        <Frame Grid.Row="2" 
               BackgroundColor="{AppThemeBinding Light=#F0F0F0, Dark=#1A1A1A}"
               BorderColor="Transparent"
               Padding="10,5">
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                <Label x:Name="StatusLabel" 
                     Text="Disconnected" 
                     FontSize="14"
                     VerticalOptions="Center"/>
                
                <Label x:Name="ConnectionInfoLabel" 
                     Text="" 
                     FontSize="12"
                     TextColor="Gray"
                     HorizontalOptions="Center"
                     VerticalOptions="Center"
                     Grid.Column="1"/>
                
                <Label x:Name="DeviceCountLabel" 
                     Text="0 devices" 
                     FontSize="12"
                     TextColor="Gray"
                     VerticalOptions="Center"
                     Grid.Column="2"/>
            </Grid>
        </Frame>
    </Grid>
</ContentPage>