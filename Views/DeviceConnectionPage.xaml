<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:Inductobot.Models.Device"
             x:Class="Inductobot.Views.DeviceConnectionPage"
             Title="UAS-WAND Connection">
    
    <Grid RowDefinitions="*,Auto" Padding="20">
        
        <!-- Content Section -->
        <ScrollView Grid.Row="0" Margin="0,0,0,10">
            <VerticalStackLayout Spacing="20">
                
                <!-- Connection Mode Selector -->
                <Frame BackgroundColor="{AppThemeBinding Light=#F0F8FF, Dark=#1A237E}"
                       BorderColor="{AppThemeBinding Light=#2196F3, Dark=#64B5F6}"
                       Padding="15">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="ðŸ”— Connection Mode" 
                               FontSize="20" 
                               FontAttributes="Bold"
                               HorizontalOptions="Center"/>
                        
                        <Label x:Name="ModeDescriptionLabel"
                               Text="Select how you want to connect to UAS-WAND devices"
                               FontSize="14"
                               TextColor="Gray"
                               HorizontalOptions="Center"/>
                        
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                            <!-- WiFi/HTTP Mode Button -->
                            <Border x:Name="WiFiModeBorder"
                                    Stroke="{AppThemeBinding Light=#2196F3, Dark=#64B5F6}"
                                    StrokeThickness="2"
                                    BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                                    Padding="15">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnWiFiModeSelected"/>
                                </Border.GestureRecognizers>
                                <VerticalStackLayout Spacing="10">
                                    <Label Text="ðŸ“¡" FontSize="36" HorizontalOptions="Center"/>
                                    <Label Text="WiFi/Network" 
                                           FontSize="16" 
                                           FontAttributes="Bold"
                                           HorizontalOptions="Center"/>
                                    <Label Text="HTTP/HTTPS API"
                                           FontSize="12"
                                           TextColor="Gray"
                                           HorizontalOptions="Center"/>
                                    <BoxView x:Name="WiFiModeIndicator"
                                             HeightRequest="3"
                                             Color="Transparent"
                                             Margin="0,5,0,0"/>
                                </VerticalStackLayout>
                            </Border>
                            
                            <!-- USB/COM Mode Button -->
                            <Border x:Name="UsbModeBorder"
                                    Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                    StrokeThickness="2"
                                    BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                                    Padding="15"
                                    Grid.Column="1">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnUsbModeSelected"/>
                                </Border.GestureRecognizers>
                                <VerticalStackLayout Spacing="10">
                                    <Label Text="ðŸ”Œ" FontSize="36" HorizontalOptions="Center"/>
                                    <Label Text="USB/Serial" 
                                           FontSize="16" 
                                           FontAttributes="Bold"
                                           HorizontalOptions="Center"/>
                                    <Label Text="COM Port API"
                                           FontSize="12"
                                           TextColor="Gray"
                                           HorizontalOptions="Center"/>
                                    <BoxView x:Name="UsbModeIndicator"
                                             HeightRequest="3"
                                             Color="Transparent"
                                             Margin="0,5,0,0"/>
                                </VerticalStackLayout>
                            </Border>
                        </Grid>
                        
                        <!-- Active Mode Status -->
                        <Frame x:Name="ActiveModeFrame"
                               BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B5E20}"
                               BorderColor="{AppThemeBinding Light=#4CAF50, Dark=#4CAF50}"
                               Padding="10"
                               IsVisible="False">
                            <Label x:Name="ActiveModeLabel"
                                   FontSize="14"
                                   HorizontalOptions="Center"/>
                        </Frame>
                    </VerticalStackLayout>
                </Frame>
                
                <!-- WiFi/Network Discovery Section (Visible in WiFi Mode) -->
                <Frame x:Name="WiFiSection"
                       BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                       BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                       Padding="15"
                       IsVisible="True">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="ðŸ“¡ WiFi/Network Devices" 
                               FontSize="18" 
                               FontAttributes="Bold"/>
                        
                        <!-- Scan Controls -->
                        <Grid ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="10">
                            <Label Text="Discovered Devices" 
                                   FontSize="20" 
                                   FontAttributes="Bold"
                                   VerticalOptions="Center"/>
                            
                            <ActivityIndicator x:Name="ScanIndicator" 
                                             IsRunning="False"
                                             WidthRequest="20"
                                             HeightRequest="20"
                                             Grid.Column="1"/>
                            
                            <Button x:Name="ScanButton"
                                    Text="Scan Network"
                                    Clicked="OnScanNetworkClicked"
                                    Grid.Column="3"/>
                        </Grid>
                        
                        <!-- Device Filter -->
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                            <Label Text="Show UAS devices only" 
                                   FontSize="14" 
                                   VerticalOptions="Center"/>
                            
                            <Switch x:Name="UasOnlyFilterSwitch"
                                    IsToggled="True"
                                    Toggled="OnFilterSwitchToggled"
                                    ThumbColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                                    OnColor="{AppThemeBinding Light=#E3F2FD, Dark=#1A237E}"
                                    Grid.Column="1"/>
                        </Grid>
                        
                        <!-- Scan Progress -->
                        <Frame x:Name="ScanProgressFrame" 
                               BackgroundColor="{AppThemeBinding Light=#F0F8FF, Dark=#1A1A2E}"
                               BorderColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                               Padding="15"
                               IsVisible="False">
                            <VerticalStackLayout Spacing="10">
                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                    <Label x:Name="ScanStatusLabel" 
                                           Text="Scanning..."
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center"/>
                                    <Label x:Name="ScanPercentLabel"
                                           Text="0%"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           HorizontalTextAlignment="End"
                                           Grid.Column="1"/>
                                </Grid>
                                
                                <ProgressBar x:Name="ScanProgressBar"
                                           Progress="0"
                                           ProgressColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"/>
                                
                                <Label x:Name="ScanDetailsLabel"
                                       Text=""
                                       FontSize="12"
                                       TextColor="Gray"
                                       IsVisible="False"/>
                            </VerticalStackLayout>
                        </Frame>
                        
                        <!-- Device List -->
                        <CollectionView x:Name="DeviceList" 
                                      HeightRequest="300"
                                      SelectionMode="Single"
                                      SelectionChanged="OnDeviceSelected">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:UASDeviceInfo">
                                    <Border Margin="0,5" 
                                            Padding="15"
                                            BackgroundColor="{AppThemeBinding Light=#F8F8F8, Dark=#2A2A2A}"
                                            Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                            StrokeThickness="1">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnDeviceTapped"/>
                                        </Border.GestureRecognizers>
                                        
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                                            <!-- Status Indicator -->
                                            <Ellipse Grid.Column="0"
                                                   WidthRequest="12"
                                                   HeightRequest="12"
                                                   VerticalOptions="Center">
                                                <Ellipse.Fill>
                                                    <SolidColorBrush Color="{Binding TrafficLightColor}"/>
                                                </Ellipse.Fill>
                                            </Ellipse>
                                            
                                            <!-- Device Info -->
                                            <VerticalStackLayout Grid.Column="1" Spacing="5">
                                                <Label Text="{Binding Name}" 
                                                     FontSize="16" 
                                                     FontAttributes="Bold"/>
                                                
                                                <Label FontSize="14" TextColor="Gray">
                                                    <Label.FormattedText>
                                                        <FormattedString>
                                                            <Span Text="{Binding IpAddress}"/>
                                                            <Span Text=":"/>
                                                            <Span Text="{Binding Port}"/>
                                                        </FormattedString>
                                                    </Label.FormattedText>
                                                </Label>
                                                
                                                <Label Text="{Binding FirmwareVersion, StringFormat='Firmware: {0}'}" 
                                                     FontSize="12" 
                                                     TextColor="Gray"
                                                     IsVisible="{Binding FirmwareVersion, Converter={StaticResource NotNullConverter}}"/>
                                                
                                                <Label Text="{Binding SerialNumber, StringFormat='S/N: {0}'}" 
                                                     FontSize="12" 
                                                     TextColor="Gray"
                                                     IsVisible="{Binding SerialNumber, Converter={StaticResource NotNullConverter}}"/>
                                            </VerticalStackLayout>
                                            
                                            <!-- Action Buttons -->
                                            <HorizontalStackLayout Grid.Column="2" Spacing="10" VerticalOptions="Center">
                                                <Button Text="Connect" 
                                                      Clicked="OnConnectAndNavigateToWiFiClicked"
                                                      CommandParameter="{Binding .}"
                                                      WidthRequest="80"
                                                      HeightRequest="35"
                                                      FontSize="12"/>
                                                
                                                <Button Text="Remove" 
                                                      Clicked="OnRemoveDeviceClicked"
                                                      CommandParameter="{Binding .}"
                                                      BackgroundColor="Red"
                                                      WidthRequest="80"
                                                      HeightRequest="35"
                                                      FontSize="12"/>
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                            
                            <CollectionView.EmptyView>
                                <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="10" Margin="20">
                                    <Image Source="dotnet_bot.png" 
                                         WidthRequest="80" 
                                         HeightRequest="80" 
                                         Opacity="0.5"/>
                                    <Label Text="No devices found" 
                                         FontSize="16" 
                                         TextColor="Gray"
                                         HorizontalOptions="Center"/>
                                    <Label Text="Click 'Scan Network' to discover devices or add one manually"
                                         FontSize="12" 
                                         TextColor="Gray"
                                         HorizontalOptions="Center"
                                         HorizontalTextAlignment="Center"/>
                                </VerticalStackLayout>
                            </CollectionView.EmptyView>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <!-- Network Information Panel -->
                <Frame BackgroundColor="{AppThemeBinding Light=#E6F3FF, Dark=#1A1A2E}"
                       BorderColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                       Padding="15">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="ðŸŒ Network Information" 
                             FontSize="20" 
                             FontAttributes="Bold"/>
                        
                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="10" RowSpacing="5">
                            <Label Grid.Column="0" Grid.Row="0" Text="Gateway:" FontSize="14" FontAttributes="Bold" VerticalOptions="Center"/>
                            <Label Grid.Column="1" Grid.Row="0" x:Name="GatewayAddressLabel" Text="Loading..." FontSize="14" VerticalOptions="Center"/>
                            
                            <Label Grid.Column="0" Grid.Row="1" Text="IP Range:" FontSize="14" FontAttributes="Bold" VerticalOptions="Center"/>
                            <Label Grid.Column="1" Grid.Row="1" x:Name="IPRangeLabel" Text="Loading..." FontSize="14" VerticalOptions="Center"/>
                            
                            <Label Grid.Column="0" Grid.Row="2" Text="Interface:" FontSize="14" FontAttributes="Bold" VerticalOptions="Center"/>
                            <Label Grid.Column="1" Grid.Row="2" x:Name="NetworkInterfaceLabel" Text="Loading..." FontSize="14" VerticalOptions="Center"/>
                        </Grid>
                        
                        <Button Text="Refresh Network" 
                              x:Name="RefreshNetworkButton"
                              Clicked="OnRefreshNetworkClicked"
                              BackgroundColor="#4A90E2"
                              TextColor="White"/>
                    </VerticalStackLayout>
                </Frame>

                <!-- Manual Connection Section -->
                <Frame BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2B2B2B}" 
                       BorderColor="Transparent"
                       Padding="15">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="ðŸ“± Add Device Manually" 
                               FontSize="16" 
                               FontAttributes="Bold"/>
                        
                        <Grid ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="10">
                            <Entry x:Name="IpAddressEntry" 
                                   Placeholder="IP Address (e.g., 192.168.1.100)"
                                   Grid.Column="0"/>
                            
                            <Entry x:Name="PortEntry" 
                                   Placeholder="Port"
                                   Text="80"
                                   Keyboard="Numeric"
                                   WidthRequest="80"
                                   Grid.Column="1"/>
                            
                            <Button Text="Add"
                                    Clicked="OnAddManualDeviceClicked"
                                    Grid.Column="2"/>
                            
                            <Button Text="Connect"
                                    Clicked="OnConnectManualAndNavigateToWiFiClicked"
                                    Grid.Column="3"/>
                        </Grid>
                        
                        <HorizontalStackLayout Spacing="10" Margin="0,5,0,0">
                            <Label Text="Quick ports:" FontSize="12" TextColor="Gray" VerticalOptions="Center"/>
                            <Button Text="80" 
                                    Clicked="OnQuickPortClicked" 
                                    WidthRequest="40" 
                                    HeightRequest="30" 
                                    FontSize="10"
                                    BackgroundColor="{AppThemeBinding Light=#E8F5E8, Dark=#2D4A2D}"
                                    TextColor="{AppThemeBinding Light=#2D7D32, Dark=#81C784}"/>
                            <Button Text="8080" 
                                    Clicked="OnQuickPortClicked" 
                                    WidthRequest="50" 
                                    HeightRequest="30" 
                                    FontSize="10"
                                    BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#1A237E}"
                                    TextColor="{AppThemeBinding Light=#1976D2, Dark=#64B5F6}"/>
                            <Button Text="443" 
                                    Clicked="OnQuickPortClicked" 
                                    WidthRequest="40" 
                                    HeightRequest="30" 
                                    FontSize="10"
                                    BackgroundColor="{AppThemeBinding Light=#FFF3E0, Dark=#E65100}"
                                    TextColor="{AppThemeBinding Light=#F57C00, Dark=#FFB74D}"/>
                            <Label Text="(HTTP recommended for ESP32)" FontSize="10" TextColor="Gray" VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Frame>

                <!-- USB/COM Port Configuration Section (Visible in USB Mode) -->
                <Frame x:Name="UsbSection"
                       BackgroundColor="{AppThemeBinding Light=#F0F8FF, Dark=#1A1A2E}" 
                       BorderColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                       Padding="15"
                       IsVisible="False">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="ðŸ”Œ USB/Serial Devices" 
                               FontSize="18" 
                               FontAttributes="Bold"/>
                        
                        <!-- Header with scan button -->
                        <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                            <Label Text="COM Port Configuration" 
                                   FontSize="16" 
                                   FontAttributes="Bold"
                                   VerticalOptions="Center"/>
                            
                            <ActivityIndicator x:Name="ComPortScanIndicator" 
                                             IsRunning="False"
                                             WidthRequest="20"
                                             HeightRequest="20"
                                             Grid.Column="1"/>
                            
                            <Button x:Name="ScanComPortsButton"
                                    Text="Scan COM Ports"
                                    Clicked="OnScanComPortsClicked"
                                    BackgroundColor="#4A90E2"
                                    TextColor="White"
                                    Grid.Column="2"/>
                        </Grid>
                        
                        <!-- COM Port Scan Progress -->
                        <Frame x:Name="ComPortScanProgressFrame" 
                               BackgroundColor="{AppThemeBinding Light=#F0F8FF, Dark=#1A1A2E}"
                               BorderColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                               Padding="15"
                               IsVisible="False">
                            <VerticalStackLayout Spacing="10">
                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                    <Label x:Name="ComPortScanStatusLabel" 
                                           Text="Scanning COM ports..."
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center"/>
                                    <Label x:Name="ComPortScanPercentLabel"
                                           Text="0%"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           HorizontalTextAlignment="End"
                                           Grid.Column="1"/>
                                </Grid>
                                
                                <ProgressBar x:Name="ComPortScanProgressBar"
                                           Progress="0"
                                           ProgressColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"/>
                                
                                <Label x:Name="ComPortScanDetailsLabel"
                                       Text=""
                                       FontSize="12"
                                       TextColor="Gray"
                                       IsVisible="False"/>
                            </VerticalStackLayout>
                        </Frame>
                        
                        <!-- COM Port List -->
                        <CollectionView x:Name="ComPortList" 
                                      HeightRequest="150"
                                      SelectionMode="Single"
                                      SelectionChanged="OnComPortSelected">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="0,2" 
                                            Padding="10"
                                            BackgroundColor="{AppThemeBinding Light=White, Dark=#2A2A2A}"
                                            Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                            StrokeThickness="1">
                                        <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="10">
                                            <Label Text="{Binding PortName}" 
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center"/>
                                            
                                            <Label Text="{Binding Description}" 
                                                   FontSize="12"
                                                   TextColor="Gray"
                                                   VerticalOptions="Center"
                                                   Grid.Column="1"/>
                                            
                                            <Label Grid.Column="2"
                                                   VerticalOptions="Center">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label" 
                                                               Binding="{Binding IsUasDevice}" 
                                                               Value="True">
                                                        <Setter Property="Text" Value="âœ“ UAS"/>
                                                        <Setter Property="TextColor" Value="Green"/>
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                            
                                            <Button Text="Connect" 
                                                    Clicked="OnConnectAndNavigateToComPortClicked"
                                                    CommandParameter="{Binding .}"
                                                    FontSize="12"
                                                    Padding="5"
                                                    BackgroundColor="#4A90E2"
                                                    TextColor="White"
                                                    Grid.Column="3"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                            
                            <CollectionView.EmptyView>
                                <Label Text="No COM ports detected. Connect a UAS device via USB and scan again."
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       TextColor="Gray"
                                       FontSize="12"/>
                            </CollectionView.EmptyView>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>
            </VerticalStackLayout>
        </ScrollView>
        
        <!-- Status Bar -->
        <Frame Grid.Row="1" 
               BackgroundColor="{AppThemeBinding Light=#F0F0F0, Dark=#1A1A1A}"
               BorderColor="Transparent"
               Padding="10,5">
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                <Label x:Name="StatusLabel" 
                     Text="Disconnected" 
                     FontSize="14"
                     VerticalOptions="Center"/>
                
                <Label x:Name="ConnectionInfoLabel" 
                     Text="" 
                     FontSize="12"
                     TextColor="Gray"
                     HorizontalOptions="Center"
                     VerticalOptions="Center"
                     Grid.Column="1"/>
                
                <Label x:Name="DeviceCountLabel" 
                     Text="0 devices" 
                     FontSize="12"
                     TextColor="Gray"
                     VerticalOptions="Center"
                     Grid.Column="2"/>
            </Grid>
        </Frame>
    </Grid>
</ContentPage>